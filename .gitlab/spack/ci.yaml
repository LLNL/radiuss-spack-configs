##############################################################################
# Copyright (c) 2021-2025, Lawrence Livermore National Security, LLC and
# RADIUSS Stack Testing project contributors.
# See the LICENSE file for details.
#
# SPDX-License-Identifier: MIT
##############################################################################

ci:
  target: gitlab
  pipeline-gen:

  - any-job:
      before_script:
        - echo "This section cannot be empty because of Spack CI implementation."

  - build-job:
    tags: [${LCSCHEDCLUSTER}, shell]
    script::
    - |
      if ${LCSCHEDCLUSTER} == "corona" ; then
        export ALLOC_ID=$(flux jobs --name="${CORONA_ALLOC_NAME}" -n -o "{id}")
        echo -e "[Information] Shared allocation ID = ${ALLOC_ID}"
        export PROXY="$( [[ -n "${ALLOC_ID}" ]] && echo "flux proxy ${ALLOC_ID}" || echo "" )"
        ${PROXY} flux watch $( ${PROXY} flux batch -o output.stdout.type=kvs ${CORONA_JOB_ALLOC} .gitlab/spack/ci-script.sh)
      elif ${LCSCHEDCLUSTER} == "dane" ; then
        export JOBID=$(squeue -h --name=${DANE_ALLOC_NAME} --format=%A)
        srun $( [[ -n "${JOBID}" ]] && echo "--jobid=${JOBID}" ) ${DANE_JOB_ALLOC} .gitlab/spack/ci-script.sh
      elif ${LCSCHEDCLUSTER} == "lassen" ; then
        lalloc ${LASSEN_JOB_ALLOC} .gitlab/spack/ci-script.sh
      elif ${LCSCHEDCLUSTER} == "tioga" ; then
        export ALLOC_ID=$(flux jobs --name="${TIOGA_ALLOC_NAME}" -n -o "{id}")
        echo -e "[Information] Shared allocation ID = ${ALLOC_ID}"
        export PROXY="$( [[ -n "${ALLOC_ID}" ]] && echo "flux proxy ${ALLOC_ID}" || echo "" )"
        ${PROXY} flux watch $( ${PROXY} flux batch -o output.stdout.type=kvs ${TIOGA_JOB_ALLOC} .gitlab/spack/ci-script.sh)
      elif ${LCSCHEDCLUSTER} == "tuolumne" ; then
        export ALLOC_ID=$(flux jobs --name="${TUOLUMNE_ALLOC_NAME}" -n -o "{id}")
        echo -e "[Information] Shared allocation ID = ${ALLOC_ID}"
        export PROXY="$( [[ -n "${ALLOC_ID}" ]] && echo "flux proxy ${ALLOC_ID}" || echo "" )"
        ${PROXY} flux watch $( ${PROXY} flux batch -o output.stdout.type=kvs ${TUOLUMNE_JOB_ALLOC} .gitlab/spack/ci-script.sh)
      else
        echo -e "[Error] Unsupported LCSCHEDCLUSTER='${LCSCHEDCLUSTER}'"
        exit 1
      fi

  - reindex-job:
      tags: [oslic, shell]
      before_script:
        - echo -e "[Information] We override reindex-job in .gitlab/spack/reindex-override.yml."
        - echo -e "[Information] The jobs are then replaced by their machine specific equivalent named rebuild-index-<machine>."
        - echo -e "[Information] The content of the reindex-job script moved to .gitlab/spack/reindex-script.sh"
        - echo -e "[Error] This job should never run, please verify you implemented an override."

  - noop-job:
      tags: [oslic, shell]

  - cleanup-job:
      tags: [oslic, shell]
