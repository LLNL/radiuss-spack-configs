##############################################################################
# Copyright (c) 2019-2024, Lawrence Livermore National Security, LLC and
# RADIUSS project contributors. See the COPYRIGHT file for details.
#
# SPDX-License-Identifier: (MIT)
##############################################################################

variables:
  TUO_ALLOC_NAME: ${CI_PROJECT_NAME}_ci_${CI_PIPELINE_ID}
  TUO_SHARED_ALLOC: "--queue=pci --exclusive --time-limit=60m --nodes=1"
  TUO_JOB_ALLOC: "--nodes=1 --begin-time=+2s"

.on-tuo:
  tags:
    - shell
    - tuo
  rules:
    # Runs except if we explicitly deactivate tuo by variable.
    - if: '$ON_TUO == "OFF"'
      when: never
    # We should always release resources allocated in the pipeline.
    - if: '$CI_JOB_NAME =~ /release-tuo/'
      when: always
    # A true statement is expected to allow jobs to run. Here is the default.
    - when: on_success

allocate-tuo:
  variables:
    GIT_STRATEGY: none
  extends: [.on-tuo, .tuo-variables]
  stage: .pre
  script:
    - |
      set -x
      flux --parent alloc ${TUO_SHARED_ALLOC} --job-name=${TUO_ALLOC_NAME} --bg

.prepare_tuo_proxy:
  script:
    - |
      export ALLOC_ID=$(flux jobs --name="${TUO_ALLOC_NAME}" -n -o "{id}")
      echo -e "[Information] Shared allocation ID = ${ALLOC_ID}"
      export PROXY="$( [[ -n "${ALLOC_ID}" ]] && echo "flux proxy ${ALLOC_ID}" || echo "" )"

get-spack-tuo:
  extends: [.on-tuo, .tuo-variables]
  stage: setup
  script:
    - !reference [.prepare_tuo_proxy, script]
    - ${PROXY} flux watch $( ${PROXY} flux batch -o output.stdout.type=kvs --nodes=1 --begin-time=+2s .gitlab/scripts/get-spack)
  needs: [allocate-tuo]

generate-on-tuo:
  extends: [.on-tuo, .tuo-variables]
  stage: generate
  script:
    - .gitlab/scripts/print-variables
    - !reference [.prepare_tuo_proxy, script]
    - ${PROXY} flux watch $( ${PROXY} flux batch -o output.stdout.type=kvs --nodes=1 --begin-time=+2s .gitlab/spack/generate-script.sh)
  artifacts:
    paths:
      - "${CI_PROJECT_DIR}/jobs_scratch_dir"
  needs: [get-spack-tuo]

build-on-tuo:
  extends: [.tuo-variables]
  stage: build
  trigger:
    include:
      - artifact: "jobs_scratch_dir/pipeline.yml"
        job: generate-on-tuo
      - project: "lc-templates/id_tokens"
        file: "id_tokens.yml"
      - local: ".gitlab/spack/reindex-tuo.yml"
    strategy: depend
    forward:
      pipeline_variables: true
  needs: [generate-on-tuo]

rm-spack-tuo:
  extends: [.on-tuo, .tuo-variables]
  stage: clean
  script:
    - !reference [.prepare_tuo_proxy, script]
    - ${PROXY} flux watch $( ${PROXY} flux batch -o output.stdout.type=kvs --nodes=1 --begin-time=+2s .gitlab/scripts/remove-spack)
  needs: [build-on-tuo]

release-tuo:
  variables:
    GIT_STRATEGY: none
  extends: [.on-tuo, .tuo-variables]
  stage: .post
  script:
    - |
      set -x
      export URI=$(flux jobs -o "{id} {name}" | grep ${TUO_ALLOC_NAME} | awk '{print $1}')
      ([[ -n "${URI}" ]] && flux job kill ${URI} || exit 0)
  needs: [rm-spack-tuo]
